<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wetter App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .location-search {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .location-search input {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            outline: none;
            min-width: 200px;
        }

        .location-search input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .location-search button {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .location-search button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .current-location {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            opacity: 0.8;
        }

        .today-box {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .today-main {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .today-temp {
            font-size: 4em;
            font-weight: 300;
        }

        .today-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .today-description {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .today-details {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .weather-icon {
            width: 80px;
            height: 80px;
            font-size: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .periods {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .period {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 80px;
        }

        .period-time {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .period-temp {
            font-size: 1.1em;
            font-weight: 500;
        }

        .period-icon {
            width: 40px;
            height: 40px;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .forecast-scroll {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .forecast-day {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .forecast-day:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .forecast-day.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .forecast-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .forecast-date {
            min-width: 80px;
        }

        .forecast-day-name {
            font-weight: 500;
        }

        .forecast-date-num {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .forecast-icon {
            width: 50px;
            height: 50px;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .forecast-temps {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .forecast-max {
            font-weight: 500;
            color: #f1c40f;
        }

        .forecast-min {
            opacity: 0.7;
        }

        .radar-section {
            margin-top: 30px;
        }

        .radar-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .radar-iframe {
            width: 100%;
            height: 400px;
            border: none;
            border-radius: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        .error {
            background: rgba(231, 76, 60, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .uv-warning {
            background: rgba(230, 126, 34, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .today-box {
                flex-direction: column;
                text-align: center;
            }

            .today-main {
                flex-direction: column;
            }

            .today-temp {
                font-size: 3em;
            }

            .periods {
                gap: 10px;
            }

            .period {
                min-width: 70px;
                padding: 10px;
            }

            .forecast-day {
                flex-direction: column;
                gap: 10px;
            }

            .forecast-left {
                flex-direction: column;
                text-align: center;
            }

            .today-details {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="location-search">
                <input type="text" id="locationInput" placeholder="Standort eingeben...">
                <button onclick="searchLocation()">Suchen</button>
                <button onclick="getCurrentLocation()">üìç</button>
            </div>
            <div class="current-location">
                <span id="currentLocation">Standort wird geladen...</span>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">Wetterdaten werden geladen...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="weatherContent" style="display: none;">
            <div class="today-box" id="todayBox">
                <div class="today-main">
                    <div id="todayIcon" class="weather-icon">‚òÄÔ∏è</div>
                    <div class="today-temp" id="todayTemp">--¬∞</div>
                </div>
                <div class="today-info">
                    <div class="today-description" id="todayDescription">--</div>
                    <div class="today-details" id="todayDetails">
                        <span>Luftfeuchtigkeit: --</span>
                        <span>Wind: --</span>
                        <span>Niederschlag: --</span>
                    </div>
                    <div id="uvWarning" class="uv-warning" style="display: none;"></div>
                </div>
            </div>

            <div class="periods" id="periodsContainer">
                <!-- Stundenvorhersage wird hier eingef√ºgt -->
            </div>

            <div class="forecast-scroll" id="forecastContainer">
                <!-- 7-Tage-Vorhersage wird hier eingef√ºgt -->
            </div>

            <div class="radar-section">
                <h3>Regenradar</h3>
                <iframe id="radarFrame" class="radar-iframe" 
                        src="https://embed.windy.com/embed.html?type=map&location=coordinates&metricWind=km%2Fh&metricTemp=%C2%B0C&zoom=8&overlay=rain&product=ecmwf&level=surface"
                        frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <script>
        let currentLat = 49.3988; // Heidelberg Standard
        let currentLon = 8.6724;
        let weatherData = null;
        let selectedDayIndex = 0;

        // Wetter-Code zu Emoji/Icon Mapping
        const weatherCodeToEmoji = {
            0: '‚òÄÔ∏è',   // Clear sky
            1: 'üå§Ô∏è',   // Mainly clear
            2: '‚õÖ',   // Partly cloudy
            3: '‚òÅÔ∏è',   // Overcast
            45: 'üå´Ô∏è',  // Fog
            48: 'üå´Ô∏è',  // Depositing rime fog
            51: 'üå¶Ô∏è',  // Light drizzle
            53: 'üå¶Ô∏è',  // Moderate drizzle
            55: 'üåßÔ∏è',  // Dense drizzle
            56: 'üåßÔ∏è',  // Light freezing drizzle
            57: 'üåßÔ∏è',  // Dense freezing drizzle
            61: 'üå¶Ô∏è',  // Slight rain
            63: 'üåßÔ∏è',  // Moderate rain
            65: 'üåßÔ∏è',  // Heavy rain
            66: 'üåßÔ∏è',  // Light freezing rain
            67: 'üåßÔ∏è',  // Heavy freezing rain
            71: 'üå®Ô∏è',  // Slight snow
            73: '‚ùÑÔ∏è',  // Moderate snow
            75: '‚ùÑÔ∏è',  // Heavy snow
            77: '‚ùÑÔ∏è',  // Snow grains
            80: 'üå¶Ô∏è',  // Slight rain showers
            81: 'üåßÔ∏è',  // Moderate rain showers
            82: '‚õàÔ∏è',  // Violent rain showers
            85: 'üå®Ô∏è',  // Slight snow showers
            86: '‚ùÑÔ∏è',  // Heavy snow showers
            95: '‚õàÔ∏è',  // Thunderstorm
            96: '‚õàÔ∏è',  // Thunderstorm with slight hail
            99: '‚õàÔ∏è'   // Thunderstorm with heavy hail
        };

        const weatherDescriptions = {
            0: 'Sonnig',
            1: '√úberwiegend sonnig',
            2: 'Teilweise bew√∂lkt',
            3: 'Bew√∂lkt',
            45: 'Neblig',
            48: 'Neblig mit Reif',
            51: 'Leichter Nieselregen',
            53: 'Nieselregen',
            55: 'Starker Nieselregen',
            56: 'Leichter gefrierender Nieselregen',
            57: 'Gefrierender Nieselregen',
            61: 'Leichter Regen',
            63: 'Regen',
            65: 'Starker Regen',
            66: 'Leichter gefrierender Regen',
            67: 'Starker gefrierender Regen',
            71: 'Leichter Schneefall',
            73: 'Schneefall',
            75: 'Starker Schneefall',
            77: 'Schneek√∂rner',
            80: 'Leichte Regenschauer',
            81: 'Regenschauer',
            82: 'Starke Regenschauer',
            85: 'Leichte Schneeschauer',
            86: 'Starke Schneeschauer',
            95: 'Gewitter',
            96: 'Gewitter mit leichtem Hagel',
            99: 'Gewitter mit schwerem Hagel'
        };

        // Initial laden
        window.addEventListener('load', () => {
            getCurrentLocation();
        });

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentLat = position.coords.latitude;
                        currentLon = position.coords.longitude;
                        fetchWeather();
                        getReverseGeocode(currentLat, currentLon);
                    },
                    error => {
                        let errorMessage = 'Unbekannter Geolocation-Fehler';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Standortzugriff verweigert';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Standort nicht verf√ºgbar';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Standortabfrage zeit√ºberschreitung';
                                break;
                        }
                        console.info('Geolocation info:', errorMessage, '- Verwende Heidelberg als Standard');
                        
                        // Fallback auf Heidelberg ohne Fehleranzeige
                        fetchWeather();
                        document.getElementById('currentLocation').textContent = 'Heidelberg, Deutschland (Standard)';
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000 // 5 Minuten Cache
                    }
                );
            } else {
                console.info('Geolocation nicht unterst√ºtzt - Verwende Heidelberg als Standard');
                fetchWeather();
                document.getElementById('currentLocation').textContent = 'Heidelberg, Deutschland (Standard)';
            }
        }

        async function getReverseGeocode(lat, lon) {
            try {
                // Nominatim (OpenStreetMap) - kostenlos ohne API Key
                // User-Agent hinzuf√ºgen f√ºr bessere Kompatibilit√§t
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'WetterApp/1.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Nominatim API Fehler: ${response.status}`);
                }
                
                const data = await response.json();
                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village || data.address.municipality || 'Unbekannt';
                    const country = data.address.country || 'Deutschland';
                    document.getElementById('currentLocation').textContent = `${city}, ${country}`;
                } else {
                    document.getElementById('currentLocation').textContent = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Reverse Geocoding fehler:', error);
                document.getElementById('currentLocation').textContent = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
            }
        }

        async function searchLocation() {
            const query = document.getElementById('locationInput').value.trim();
            if (!query) return;

            try {
                showLoading(true);
                
                // Nominatim Geocoding - kostenlos ohne API Key
                // User-Agent und Referer f√ºr bessere Kompatibilit√§t
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'WetterApp/1.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Geocoding API Fehler: ${response.status}`);
                }
                
                const locations = await response.json();
                
                if (locations && locations.length > 0) {
                    const location = locations[0];
                    currentLat = parseFloat(location.lat);
                    currentLon = parseFloat(location.lon);
                    
                    // Bessere Standortbeschreibung
                    let locationName = location.display_name;
                    if (location.address) {
                        const city = location.address.city || location.address.town || location.address.village || location.address.municipality;
                        const country = location.address.country;
                        if (city && country) {
                            locationName = `${city}, ${country}`;
                        }
                    }
                    
                    document.getElementById('currentLocation').textContent = locationName;
                    document.getElementById('locationInput').value = ''; // Input leeren
                    
                    fetchWeather();
                } else {
                    showError('Standort nicht gefunden. Versuchen Sie es mit einer anderen Schreibweise.');
                    showLoading(false);
                }
            } catch (error) {
                console.error('Geocoding Fehler:', error);
                showError('Fehler beim Suchen des Standorts. Bitte versuchen Sie es sp√§ter erneut.');
                showLoading(false);
            }
        }

        async function fetchWeather() {
            try {
                showLoading(true);
                
                // Open-Meteo API - kostenlos ohne API Key
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m,uv_index&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Europe/Berlin&forecast_days=7`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                weatherData = await response.json();
                selectedDayIndex = 0;
                updateDisplay();
                updateRadar();
                showLoading(false);
            } catch (error) {
                console.error('Wetter API Fehler:', error);
                showError('Fehler beim Laden der Wetterdaten: ' + error.message);
            }
        }

        function updateDisplay() {
            if (!weatherData) return;

            updateTodayBox();
            updateHourlyForecast();
            updateDailyForecast();
        }

        function updateTodayBox() {
            const isToday = selectedDayIndex === 0;
            let weatherCode, temp, humidity, windSpeed, precipitation;
            
            if (isToday) {
                weatherCode = weatherData.current.weather_code;
                temp = Math.round(weatherData.current.temperature_2m);
                humidity = weatherData.current.relative_humidity_2m;
                windSpeed = Math.round(weatherData.current.wind_speed_10m);
                precipitation = Math.round(weatherData.hourly.precipitation_probability[0] || 0);
            } else {
                weatherCode = weatherData.daily.weather_code[selectedDayIndex];
                const maxTemp = Math.round(weatherData.daily.temperature_2m_max[selectedDayIndex]);
                const minTemp = Math.round(weatherData.daily.temperature_2m_min[selectedDayIndex]);
                document.getElementById('todayTemp').textContent = `${maxTemp}¬∞ / ${minTemp}¬∞`;
                
                // F√ºr nicht-heute Tage approximieren wir die Werte
                humidity = 65; // Durchschnittswert
                windSpeed = Math.round(weatherData.current.wind_speed_10m);
                precipitation = Math.round(weatherData.daily.precipitation_probability_max[selectedDayIndex] || 0);
            }
            
            // Icon und Temperatur
            document.getElementById('todayIcon').textContent = weatherCodeToEmoji[weatherCode] || '‚ùì';
            
            if (isToday) {
                document.getElementById('todayTemp').textContent = `${temp}¬∞`;
            }
            
            // Beschreibung
            document.getElementById('todayDescription').textContent = weatherDescriptions[weatherCode] || 'Unbekannt';
            
            // Details
            document.getElementById('todayDetails').innerHTML = `
                <span>Luftfeuchtigkeit: ${humidity}%</span>
                <span>Wind: ${windSpeed} km/h</span>
                <span>Niederschlag: ${precipitation}%</span>
            `;
            
            // UV Warnung
            const uvWarning = document.getElementById('uvWarning');
            if (isToday && weatherData.current.uv_index && weatherData.current.uv_index > 6) {
                uvWarning.style.display = 'block';
                uvWarning.textContent = `‚ö†Ô∏è Hoher UV-Index: ${weatherData.current.uv_index.toFixed(1)}`;
            } else {
                uvWarning.style.display = 'none';
            }
        }

        function updateHourlyForecast() {
            const container = document.getElementById('periodsContainer');
            const hours = [3, 6, 9, 12, 15, 18];
            
            container.innerHTML = '';
            
            hours.forEach((hour, index) => {
                const hourIndex = Math.min(index * 4, weatherData.hourly.temperature_2m.length - 1);
                const temp = Math.round(weatherData.hourly.temperature_2m[hourIndex]);
                const weatherCode = weatherData.hourly.weather_code[hourIndex];
                
                const periodElement = document.createElement('div');
                periodElement.className = 'period';
                
                periodElement.innerHTML = `
                    <div class="period-time">${hour.toString().padStart(2, '0')}:00</div>
                    <div class="period-icon">${weatherCodeToEmoji[weatherCode] || '‚ùì'}</div>
                    <div class="period-temp">${temp}¬∞</div>
                `;
                
                container.appendChild(periodElement);
            });
        }

        function updateDailyForecast() {
            const container = document.getElementById('forecastContainer');
            container.innerHTML = '';
            
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const isSelected = i === selectedDayIndex;
                const maxTemp = Math.round(weatherData.daily.temperature_2m_max[i]);
                const minTemp = Math.round(weatherData.daily.temperature_2m_min[i]);
                const weatherCode = weatherData.daily.weather_code[i];
                
                const dayElement = document.createElement('div');
                dayElement.className = `forecast-day ${isSelected ? 'active' : ''}`;
                dayElement.onclick = () => selectDay(i);
                
                const dayName = i === 0 ? 'Heute' : dayNames[date.getDay()];
                const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                
                dayElement.innerHTML = `
                    <div class="forecast-left">
                        <div class="forecast-date">
                            <div class="forecast-day-name">${dayName}</div>
                            <div class="forecast-date-num">${dateStr}</div>
                        </div>
                        <div class="forecast-icon">${weatherCodeToEmoji[weatherCode] || '‚ùì'}</div>
                    </div>
                    <div class="forecast-temps">
                        <span class="forecast-max">${maxTemp}¬∞</span>
                        <span class="forecast-min">${minTemp}¬∞</span>
                    </div>
                `;
                
                container.appendChild(dayElement);
            }
        }

        function selectDay(index) {
            selectedDayIndex = index;
            updateTodayBox();
            updateDailyForecast();
        }

        function updateRadar() {
            const radarFrame = document.getElementById('radarFrame');
            const radarUrl = `https://embed.windy.com/embed.html?type=map&location=coordinates&lat=${currentLat}&lon=${currentLon}&metricWind=km%2Fh&metricTemp=%C2%B0C&zoom=8&overlay=rain&product=ecmwf&level=surface`;
            radarFrame.src = radarUrl;
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('weatherContent').style.display = show ? 'none' : 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loadingIndicator').style.display = 'none';
            // Fehlermeldung nach 5 Sekunden automatisch ausblenden
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
                if (weatherData) {
                    document.getElementById('weatherContent').style.display = 'block';
                }
            }, 5000);
        }

        // Enter-Taste f√ºr Suche
        document.getElementById('locationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
    </script>
</body>
</html>
